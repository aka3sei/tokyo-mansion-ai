import streamlit as st
import pandas as pd
import pickle
import lightgbm as lgb

# --- 1. データ定義（23区詳細レポート） ---
ku_details = {
    '千代田区': "「番町・麹町を中心とした国内最高峰の邸宅街。供給が極めて少なく、築年数を問わず資産維持率は国内トップクラスです。」\n【人気エリア】一番町〜六番町、麹町、紀尾井町、富士見\n【ブランド立地】番町エリアの『ザ・パークハウスグラン』や『プラウド一番町』は別格。富士見周辺の再開発タワーも極めて高い人気を誇ります。\n【開発情報】九段下・飯田橋周辺の駅前再開発により、歴史ある街並みに最新の利便性が加わり、価値がさらに底上げされています。",
    
    '中央区': "「銀座・日本橋の商住近接エリアと、勝どき・晴海の湾岸エリアが融合。常に話題性の絶えない、流動性の高いマーケットです。」\n【人気エリア】日本橋、人形町、勝どき、月島、晴海\n【ブランド立地】『パークタワー勝どき』など駅直結開発が相場を牽引。日本橋周辺の『プラウド』『パークホームズ』も堅調です。\n【開発情報】築地市場跡地の巨大開発や、晴海フラッグの入居開始、日本橋川上空の首都高地下化など、街の姿が劇的に進化中です。",
    
    '港区': "「3A（青山・赤坂・麻布）は別格。国内外の富裕層や投資資金が集中する、日本不動産の頂点といえるエリアです。」\n【人気エリア】元麻布、南青山、赤坂、白金高輪、芝浦\n【ブランド立地】『パークコート赤坂檜町ザ・タワー』等のランドマークが点在。港区ではブランド名がそのまま資産価値の証明となります。\n【開発情報】麻布台ヒルズの開業に加え、高輪ゲートウェイ駅周辺の『TAKANAWA GATEWAY CITY』全面開業を控え、期待値は高まる一方です。",
    
    '新宿区': "「西新宿の超高層タワー群から、市谷・神楽坂の邸宅街まで多様な顔を持ち、職住近接を求める層に絶大な人気を誇ります。」\n【人気エリア】市谷砂土原町、神楽坂、西新宿、下落合\n【ブランド立地】神楽坂の『パークホームズ』や市谷の『プラウド』など、落ち着いた山手内側の高台に優良物件が集中しています。\n【開発情報】新宿駅西口（小田急・京王）の巨大再開発により、ターミナルとしての利便性がさらに飛躍。西新宿の居住価値が再評価されています。",
    
    '文京区': "「山手線内側で最も教育環境に優れたエリア。文教地区としてのブランドが確立されており、ファミリー層の指名買いが絶えません。」\n【人気エリア】本駒込（大和郷）、小石川、西片、千駄木\n【ブランド立地】『パークコート文京小石川』や『ザ・パークハウス小石川』など、名門小学校近くの物件は中古でも値崩れしません。\n【開発情報】春日・後楽園駅前の再開発完了により生活利便性が劇的に向上。伝統と先進が融合する街として完成度が高まっています。",
    
    '台東区': "「上野・浅草の文化拠点に加え、蔵前周辺の再開発で若年富裕層が流入。23区内でも地価上昇率が際立つエリアです。」\n【人気エリア】上野池之端、蔵前、浅草、谷中\n【ブランド立地】『パークホームズ蔵前』や『プラウド浅草』など、東東京のトレンドを牽引するブランド供給が活発です。\n【開発情報】蔵前駅前の複合開発や浅草通りの整備が進み、『リノベーションの聖地』から『洗練された住宅街』へと変貌を遂げました。",
    
    '墨田区': "「スカイツリー周辺の観光開発と、錦糸町の高い商業利便性が魅力。都心への近さと環境の良さのバランスが取れています。」\n【人気エリア】錦糸町、両国、押上、向島\n【ブランド立地】『ザ・パークハウス錦糸町』などの駅近・大規模物件が、エリア全体の相場を強力に下支えしています。\n【開発情報】錦糸町駅南口の再開発議論が進んでおり、将来的にはさらなる拠点性の向上が期待されています。",
    
    '江東区': "「豊洲・有明の湾岸タワーマンションの聖地。再開発による街の進化が続いており、将来的な資産価値の上昇も期待大です。」\n【人気エリア】豊洲、有明、清澄白河、東陽町\n【ブランド立地】『パークホームズ豊洲ザ・レジデンス』や『プラウドシティ有明』など、大規模な街づくりとブランドが一体化しています。\n【開発情報】地下鉄8号線（有楽町線）の延伸が決定。枝川・千石周辺の新駅設置により、周辺エリアの相場上昇が始まっています。",
    
    '品川区': "「御殿山などの伝統的な高台邸宅地と、武蔵小山・大崎の現代的な再開発が融合。交通の要所として圧倒的な強みを持ちます。」\n【人気エリア】御殿山、高輪、武蔵小山、大崎\n【ブランド立地】『パークシティ武蔵小山』や『プラウドタワー東五反田』など、駅前の再開発ランドマークが極めて強力です。\n【開発情報】武蔵小山の継続的な開発に加え、品川駅のリニア始発駅化に向けた周辺整備により、将来の付加価値は抜群です。",
    
    '目黒区': "「洗練された東急沿線の文化と、中目黒周辺の活気が融合。高所得層が住みたい街として常に上位に挙がる人気エリアです。」\n【人気エリア】青葉台、自由が丘、中目黒、八雲、駒場\n【ブランド立地】『プラウド駒場』や『ザ・パークハウス自由が丘』など、低層かつ重厚なデザインが街並みに調和しています。\n【開発情報】自由が丘駅前で複数の大規模再開発プロジェクトが始動。駅前の景観が刷新され、ブランド価値がさらに高まっています。",
    
    '大田区': "「田園調布や山王などの歴史的邸宅地から、利便性の高い蒲田まで。羽田アクセスも良く、幅広い需要をカバーします。」\n【人気エリア】田園調布、山王、久が原、雪が谷大塚\n【ブランド立地】山王の『ザ・パークハウス』など、地歴の良い高台に大手ブランドが並ぶのが特徴です。\n【開発情報】蒲蒲線（新空港線）プロジェクトの進展や、羽田イノベーションシティの拡大により、区南部のポテンシャルが再注目されています。",
    
    '世田谷区': "「圧倒的な定住人気を誇る国内最大級の住宅都市。良好な住環境が維持されており、資産価値の安定感は抜群です。」\n【人気エリア】成城、深沢、等々力、代沢、下北沢\n【ブランド立地】『プラウド代沢』や『パークホームズ桜新町』など、第一種低層地域の落ち着いた物件が豊富に揃います。\n【開発情報】下北沢駅周辺の線路跡地開発により、街の回遊性が向上。感度の高い層の流入が資産価値を押し上げています。",
    
    '渋谷区': "「松濤や広尾などの超一等地から代官山まで。日本屈指の高級物件が供給され、常に需要が供給を上回る希少エリアです。」\n【人気エリア】広尾、松濤、代官山、神宮前、代々木上原\n【ブランド立地】『ザ・パークハウス代々木上原』など、駅近と静寂を両立させた立地にブランドの真髄があります。\n【開発情報】100年に一度といわれる渋谷駅周辺の巨大開発により、徒歩圏内のマンションへの職住近接需要が激増しています。",
    
    '中野区': "「中野駅周辺の巨大再開発により、一躍注目度が増大。職・住・学が融合する、23区内で今最も熱いエリアの一つです。」\n【人気エリア】中野、東中野、本町、松が丘\n【ブランド立地】サンプラザ建て替えを含む再開発の中核『パークタワー中野』を筆頭に、駅前の価値が劇的に上昇中です。\n【開発情報】駅前の4棟の大規模ビル建設によりビジネス拠点機能が強化。地価上昇率も23区トップクラスを記録しています。",
    
    '杉並区': "「荻窪や浜田山など、中央線・井の頭線沿線の落ち着いた環境が特徴。地に足の着いたファミリー層からの支持が絶大です。」\n【人気エリア】浜田山、荻窪、善福寺、久我山、阿佐ヶ谷\n【ブランド立地】『パークシティ浜田山』は低層ブランドの最高峰。阿佐ヶ谷駅前の開発など、伝統ある街に新風が吹いています。\n【開発情報】中央線の連続立体交差事業や駅前整備により、南北の分断が解消され、より回遊性の高い街へと進化しています。",
    
    '豊島区': "「池袋の劇的な再開発により利便性が飛躍。東池袋のタワー群を中心に、都心の新拠点として評価が急上昇中です。」\n【人気エリア】目白、南池袋、東池袋、駒込\n【ブランド立地】『プラウドタワー東池袋』など、駅直結や地下通路直結のブランドタワーがエリア相場を牽引しています。\n【開発情報】池袋駅西口の巨大再開発が本格始動。三菱地所等による超高層ビル建設で、エリア全体の格付けが変わろうとしています。",
    
    '北区': "「赤羽の圧倒的な交通利便性と、西ヶ原の良好な住環境が再評価。実利を重視する実需層に選ばれている堅実なエリアです。」\n【人気エリア】赤羽、王子、西ヶ原、滝野川\n【ブランド立地】『プラウドシティ赤羽』など、駅近の大規模再開発物件が地域のランドマークとして君臨しています。\n【開発情報】赤羽一丁目街区の再開発や、王子駅周辺の『王子のまちづくり』により、城北のハブとしての機能が強化されています。",
    
    '荒川区': "「日暮里・西日暮里の再開発により街並みが洗練。山手線利用可能なアクセスの良さが、共働き世帯に高く評価されています。」\n【人気エリア】日暮里、西日暮里、南千住、町屋\n【ブランド立地】『プラウド西日暮里』など、山手線駅徒歩圏のブランド物件は非常に高い流動性を誇ります。\n【開発情報】西日暮里駅前で大規模なタワーマンションと商業施設の複合開発が進行中。エリアのイメージが一新されようとしています。",
    
    '板橋区': "「三田線による都心直通の利便性と、加賀エリアの歴史ある住環境が魅力。派手さはありませんが、住みやすさは抜群です。」\n【人気エリア】加賀、成増、板橋、志村坂上\n【ブランド立地】『加賀レジデンス』周辺のパークホームズ群は、緑豊かな別格の住環境を形成しています。\n【開発情報】板橋駅西口の再開発タワー計画が進展。都心へのゲートウェイとしてのステータスが向上しています。",
    
    '練馬区': "「23区内屈指の緑の多さと、副都心線開通による利便性向上が特徴。自然豊かな高級住宅地も点在するバランスの良い街です。」\n【人気エリア】石神井公園、大泉学園、練馬、小竹向原\n【ブランド立地】『プラウド石神井公園』など、風致地区に隣接するブランド物件は永住志向が強く、価値が安定しています。\n【開発情報】石神井公園駅南口の再開発が進み、高級マンションと洗練された商業施設が調和する街並みが完成しつつあります。",
    
    '足立区': "「北千住の大躍進により人気が定着。購入しやすい価格帯ながら高い利便性を享受でき、近年はタワー開発も盛んです。」\n【人気エリア】北千住、綾瀬、西新井、千住\n【ブランド立地】『プラウドタワー北千住』等の駅前再開発タワーが、エリアの資産価値とイメージを牽引しています。\n【開発情報】北千住駅東口の大学誘致や綾瀬駅前の再開発により、若い世代の流入が加速し、活気が増しています。",
    
    '葛飾区': "「江戸川の自然と、再開発が進む金町・新小岩の利便性が共存。下町情緒を活かした近代的な街づくりが進んでいます。」\n【人気エリア】金町、亀有、新小岩、柴又\n【ブランド立地】『プラウドシティ金町』など、大規模な街づくりと一体となったブランド供給が成功を収めています。\n【開発情報】新小岩駅ビルの完成や金町駅周辺の継続的な再開発により、都心通勤層の新たな受け皿として注目されています。",
    
    '江戸川区': "「子育て支援策の充実は都内随一。東西線沿線の利便性と広い住環境を求める層に、非常に安定した人気を誇ります。」\n【人気エリア】葛西、西葛西、船堀、小岩\n【ブランド立地】『プラウドタワー小岩』などの駅前再開発物件が、下町のイメージを一新する近代的な空間を創出しています。\n【開発情報】小岩駅周辺で複数の再開発プロジェクトが同時進行。区全体の格付けを底上げする起爆剤となっています。"
}

# --- 2. ページ基本設定 ---
st.set_page_config(page_title="23区マンションAI査定", layout="centered")

st.title("🏙️ 東京23区マンション AI査定システム")
st.write("AIが統計データから「ベース価格」を算出し、ブランド価値を含めた「期待レンジ」を表示します。")

# --- 3. モデルの読み込み ---
@st.cache_resource
def load_model():
    with open('satei_model.pkl', 'rb') as f:
        return pickle.load(f)

try:
    model = load_model()
except Exception as e:
    st.error("モデルの読み込みに失敗しました。'satei_model.pkl' があるか確認してください。")

# --- 4. 賃料係数設定 ---
rent_factor = {
    '港区': 1.85, '千代田区': 1.85, '中央区': 1.75, '渋谷区': 1.75, '新宿区': 1.65,
    '文京区': 1.55, '目黒区': 1.55, '豊島区': 1.45, '台東区': 1.45, '品川区': 1.45,
    '世田谷区': 1.35, '中野区': 1.35, '杉並区': 1.30, '江東区': 1.30, '大田区': 1.25,
    '墨田区': 1.20, '荒川区': 1.15, '北区': 1.15, '練馬区': 1.10, '板橋区': 1.10,
    '江戸川区': 1.05, '足立区': 1.00, '葛飾区': 1.00
}

# --- 5. 入力フォーム ---
with st.container():
    col1, col2 = st.columns(2)
    with col1:
        ku = st.selectbox("区を選択", list(rent_factor.keys()))
        loc = st.text_input("所在地（例：南青山、勝どき）", "芝浦")
    with col2:
        area = st.number_input("専有面積 (㎡)", min_value=10.0, max_value=300.0, value=60.0, step=1.0)
        walk = st.slider("駅より徒歩 (分)", 0, 30, 5)
    year_now = st.number_input("築年月 (西暦)", min_value=1970, max_value=2025, value=2015)

# --- 6. 査定ボタン（中央配置デザイン） ---
st.markdown("""
    <style>
    /* ボタンを包む枠を中央寄せにする */
    .stButton {
        display: flex;
        justify-content: center;
        width: 100%;
        padding: 30px 0;
    }
    /* ボタン自体のデザイン */
    .stButton > button {
        width: 350px !important;
        height: 75px !important;
        font-size: 26px !important;
        background-color: #ff4b4b !important;
        color: white !important;
        border-radius: 15px !important;
        font-weight: bold !important;
        box-shadow: 0 4px 15px rgba(255, 75, 75, 0.4);
        border: none !important;
    }
    .stButton > button:hover {
        background-color: #ff3333 !important;
        transform: scale(1.02);
        transition: 0.3s;
    }
    </style>
    """, unsafe_allow_html=True)

# ボタンの実行
if st.button("AI査定を実行する"):
    # --- 推論処理 ---
    input_df = pd.DataFrame([{
        '区': ku,
        '所在': f"東京都{ku}{loc}",
        '専有面積': area,
        '駅より徒歩': walk,
        '築年月': year_now
    }])

    # カテゴリー型へ変換
    input_df['区'] = input_df['区'].astype('category')
    input_df['所在'] = input_df['所在'].astype('category')

    # 予測
    price_base = model.predict(input_df)[0]
    
    input_future = input_df.copy()
    input_future['築年月'] = year_now - 5
    price_future = model.predict(input_future)[0]
    
    # 計算
    f = rent_factor.get(ku, 1.0)
    age_effect = max(0.65, 1.0 - (max(0, 2025 - year_now) * 0.008))
    m2_rent = 3300 * f * age_effect
    monthly_rent = m2_rent * area
    annual_rent_man = (monthly_rent * 12) / 10000
    yield_rate = (annual_rent_man / price_base) * 100

    # --- 7. 結果表示 ---
    st.divider()
    st.subheader(f"📊 診断結果: {ku} {loc}")
    
    m1, m2 = st.columns(2)
    m1.metric("AI統計ベース価格", f"{price_base:,.0f} 万円")
    m2.metric("AI予想利回り", f"{yield_rate:.2f} %")
    
    st.info(f"✨ **ブランド期待価格レンジ**: {round(price_base*1.0):,} 〜 {round(price_base*1.2):,} 万円")
    st.write(f"💡 5年後の予想価格: **{price_future:,.0f} 万円**")

    st.divider()
    st.subheader(f"🏙️ {ku}のマーケット分析")
    st.info(ku_details.get(ku, "詳細データ準備中"))



