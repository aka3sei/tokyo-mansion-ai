import streamlit as st
import pandas as pd
import pickle
import lightgbm as lgb

# --- 1. データ定義（23区詳細レポート） ---
ku_details = {
    '千代田区': "「番町や麹町など、国内最高峰の邸宅街を擁するエリア。供給が極めて少なく、築年数を問わず資産維持率は国内トップクラスです。」\n【人気エリア】番町、麹町、紀尾井町、九段北\n【ブランド】グラン、パークマンション、ザ・パークハウスグラン\n【補足】官公庁に近く、三番町などは「日本一の住所」として築古でも値崩れなし。",
    '中央区': "「銀座・日本橋の商住近接エリアと、勝どき・晴海の湾岸エリアが融合。常に高い流動性を誇るマーケットです。」\n【人気エリア】銀座、日本橋、勝どき、月島、晴海\n【ブランド】パークタワー、ザ・パークハウス、ドゥ・トゥール\n【補足】銀座・日本橋の実需と、湾岸タワーマンションの投資需要が非常に強いのが特徴。",
    '港区': "「3A（青山・赤坂・麻布）に代表されるブランド力は圧倒的。国内外の富裕層や投資資金が集中する日本不動産の頂点です。」\n【人気エリア】南青山、赤坂、元麻布、白金、虎ノ門\n【ブランド】パークコート、森ビル（ヒルズ）、ホーマット\n【補足】国内外の資金が流入しやすく、景況感に左右されにくい別格の資産価値を誇ります。",
    '新宿区': "「西新宿の超高層タワー群から、市谷・神楽坂の邸宅街まで多様な顔を持ち、職住近接を求める層に絶大な人気です。」\n【人気エリア】市谷、神楽坂、西新宿、下落合\n【ブランド】パークコート、ザ・パークハウス、ラ・トゥール\n【補足】交通網の結節点であり、常に高い賃貸需要が中古価格を強力に下支えしています。",
    '文京区': "「山手線内側で最も教育環境に優れたエリア。文教地区としてのブランドが確立されており、ファミリー層の指名買いが絶えません。」\n【人気エリア】本駒込、小石川、西片、千駄木\n【ブランド】パークコート、ザ・パークハウス、プラウド\n【補足】「教育」を目的とした定住者が多く、目立った値崩れが非常に少ない堅実な市場です。",
    '台東区': "「浅草・上野の観光・文化拠点に加え、蔵前周辺の再開発で若年富裕層が流入。地価上昇率が際立つエリアです。」\n【人気エリア】上野、浅草、蔵前、谷中\n【ブランド】パークホームズ、ブリリア、ピアース\n【補足】蔵前（東京のブルックリン）などの『東東京ブーム』により資産価値が急上昇中。",
    '墨田区': "「スカイツリー周辺の街並み整備と錦糸町の高い利便性が魅力。都心への近さと環境の良さのバランスが取れています。」\n【人気エリア】押上、錦糸町、両国\n【ブランド】ブリリア、パークホームズ、ザ・パームス\n【補足】錦糸町エリアの再開発と利便性により、共働き世帯からの支持が非常に堅調です。",
    '江東区': "「豊洲・有明に代表される湾岸タワーマンションの聖地。都心へのアクセスも良く、将来的な発展性も期待できます。」\n【人気エリア】豊洲、有明、東陽町、清澄白河\n【ブランド】パークホームズ、シティタワー、ブランズ\n【補足】再開発による街の進化が続いており、将来的な資産価値の上昇が最も期待できるエリアの一つ。",
    '品川区': "「御殿山などの伝統的な高台邸宅地と、武蔵小山・大崎の現代的な再開発が融合。交通の要所として圧倒的な利便性を誇ります。」\n【人気エリア】御殿山、高輪（北品川）、武蔵小山、大崎\n【ブランド】パークシティ、シティタワー、グランドメゾン\n【補足】リニア始発駅となる品川駅や武蔵小山の再開発により、将来的な付加価値が極めて高いエリア。",
    '目黒区': "「洗練された東急沿線の文化と、中目黒周辺の活気が融合。高所得層が住みたい街として常に上位に挙がる人気エリアです。」\n【人気エリア】青葉台、駒場、自由が丘、中目黒、八雲\n【ブランド】ピアース、グランドメゾン、プラウド\n【補足】東急東横線沿線のブランド力が強く、中古市場でも「指名買い」が多いのが特徴。",
    '大田区': "「田園調布や山王などの歴史的邸宅地から、利便性の高い蒲田まで。羽田アクセスも良く、広域の需要をカバーします。」\n【人気エリア】田園調布、山王、久が原、雪が谷大塚\n【ブランド】ザ・パークハウス、プラウド、パークホームズ\n【補足】田園調布・山王は伝統的な高級住宅地として別格の扱い。沿岸部は空港関係者の需要も豊富。",
    '世田谷区': "「圧倒的な定住人気を誇る国内最大級の住宅都市。良好な住環境が維持されており、資産価値の安定感は抜群です。」\n【人気エリア】成城、深沢、等々力、代沢、下北沢\n【ブランド】グランドメゾン、プラウド、パークホームズ\n【補足】成城や深沢は邸宅地としてブランドが確立。低層マンションを中心に価格が安定しています。",
    '渋谷区': "「松濤や広尾などの超一等地と、代々木上原の洗練された住環境が共存。常に最先端のライフスタイルが求められるエリアです。」\n【人気エリア】松濤、広尾、代官山、神宮前、代々木上原\n【ブランド】ラ・トゥール、プラウド、パークマンション\n【補足】広尾周辺は外国人需要も高く、トレンドに敏感な富裕層が絶え間なく流入する希少な市場。",
    '中野区': "「中野駅周辺の100年に一度と言われる再開発により、一躍注目度が増大。職・住・学が融合する街へ変貌中です。」\n【人気エリア】中野、東中野、本町\n【ブランド】パークタワー、ザ・パークハウス、プラウド\n【補足】サブカルチャーのイメージから高付加価値な住宅地へと進化しており、資産価値が上昇中。",
    '杉並区': "「阿佐ヶ谷や荻窪など中央線沿線の落ち着いた住環境が特徴。教育熱心な世帯が多く、地に足の着いた人気があります。」\n【人気エリア】浜田山、荻窪、善福寺、久我山\n【ブランド】パークシティ、プラウド、パークホームズ\n【補足】浜田山などの高級低層マンションは中古市場でも希少。中央線ブランドへの信頼は絶大です。",
    '豊島区': "「池袋の劇的な再開発により利便性が飛躍的に向上。タワーマンションの供給も活発で、都心の新拠点として評価が急上昇中です。」\n【人気エリア】目白、駒込、南池袋、東池袋\n【ブランド】ブリリア、シティタワー、プラウド\n【補足】池袋駅周辺のブリリアタワーなどは、エリア全体の相場を牽引するランドマークとなっています。",
    '北区': "「赤羽の圧倒的な交通利便性と、西ヶ原周辺の良好な住環境が再評価。実利を重視する実需層に選ばれているエリアです。」\n【人気エリア】赤羽、王子、西ヶ原\n【ブランド】プラウド、パークホームズ、シティテラス\n【補足】赤羽エリアの5路線利用可能な交通力は強み。23区内では相対的に価格バランスが良いエリア。",
    '荒川区': "「日暮里・西日暮里の再開発により街並みが洗練。山手線利用可能な交通アクセスの良さが、共働き層に高く評価されています。」\n【人気エリア】日暮里、南千住、西日暮里\n【ブランド】アトラス、シティタワー、パークホームズ\n【補足】交通利便性が非常に高い一方、他区に比べて価格が抑えられており、コストパフォーマンスに優れます。",
    '板橋区': "「三田線による都心直通の利便性と、加賀エリアの歴史ある住環境が魅力。派手さはありませんが、住みやすさへの満足度が高いエリアです。」\n【人気エリア】加賀、成増、板橋、志村坂上\n【ブランド】パークホームズ、プラウド、加賀レジデンス\n【補足】「加賀」エリアは加賀藩下屋敷跡の歴史があり別格。子育て世代からの支持も非常に安定しています。",
    '練馬区': "「23区内屈指の緑の多さと、副都心線の開通による利便性の向上が特徴。自然豊かな高級住宅地も点在するバランスの良い街です。」\n【人気エリア】練馬、石神井公園、大泉学園\n【ブランド】プラウド、パークホームズ、ブリリア\n【補足】石神井公園周辺の風致地区は、都内でも有数の緑豊かな邸宅街。定住意欲の高い層に人気です。",
    '足立区': "「北千住の大躍進により、城東エリアの重要拠点としての地位を確立。購入しやすい価格帯ながら、高い利便性を享受できます。」\n【人気エリア】北千住、綾瀬、西新井\n【ブランド】シティタワー、パークホームズ、千住ザ・タワー\n【補足】北千住駅周辺のタワー化が進み、イメージが刷新。広い住戸を確保したいファミリー層に人気。",
    '葛飾区': "「江戸川沿いの自然と、再開発が進む金町・新小岩の利便性が共存。下町情緒を活かした独自の街づくりが進んでいます。」\n【人気エリア】金町、亀有、新小岩\n【ブランド】プラウド、シティタワー、パークホームズ\n【補足】金町駅前の大規模な大学誘致や再開発により、都心通勤者の新たな選択肢として注目されています。",
    '江戸川区': "「子育て支援策の充実度は都内トップクラス。東西線沿線の高い利便性と広い住環境を求める層に、安定した人気を誇ります。」\n【人気エリア】葛西、西葛西、船堀\n【ブランド】プラウド、パークホームズ、ライオンズ\n【補足】東西線による大手町・日本橋への直通利便性が強み。子育て環境を最優先する世帯に選ばれています。"
}

# --- 2. ページ基本設定 ---
st.set_page_config(page_title="23区マンションAI査定", layout="centered")

st.title("🏙️ 東京23区マンション AI査定システム")
st.write("AIが統計データから「ベース価格」を算出し、ブランド価値を含めた「期待レンジ」を表示します。")

# --- 3. モデルの読み込み ---
@st.cache_resource
def load_model():
    with open('satei_model.pkl', 'rb') as f:
        return pickle.load(f)

try:
    model = load_model()
except Exception as e:
    st.error("モデルの読み込みに失敗しました。'satei_model.pkl' があるか確認してください。")

# --- 4. 賃料係数設定 ---
rent_factor = {
    '港区': 1.85, '千代田区': 1.85, '中央区': 1.75, '渋谷区': 1.75, '新宿区': 1.65,
    '文京区': 1.55, '目黒区': 1.55, '豊島区': 1.45, '台東区': 1.45, '品川区': 1.45,
    '世田谷区': 1.35, '中野区': 1.35, '杉並区': 1.30, '江東区': 1.30, '大田区': 1.25,
    '墨田区': 1.20, '荒川区': 1.15, '北区': 1.15, '練馬区': 1.10, '板橋区': 1.10,
    '江戸川区': 1.05, '足立区': 1.00, '葛飾区': 1.00
}

# --- 5. 入力フォーム ---
with st.container():
    col1, col2 = st.columns(2)
    with col1:
        ku = st.selectbox("区を選択", list(rent_factor.keys()))
        loc = st.text_input("所在地（例：南青山、勝どき）", "芝浦")
    with col2:
        area = st.number_input("専有面積 (㎡)", min_value=10.0, max_value=300.0, value=60.0, step=1.0)
        walk = st.slider("駅より徒歩 (分)", 0, 30, 5)
    year_now = st.number_input("築年月 (西暦)", min_value=1970, max_value=2025, value=2015)
# ボタンを中央寄せ・巨大化するスタイル設定
st.markdown("""
    <style>
    /* ボタンを包む要素を中央に寄せる */
    div.stButton {
        text-align: center;
    }
    /* ボタン自体の見た目をカスタマイズ */
    div.stButton > button:first-child {
        display: inline-block;
        width: 100%;           /* 横幅いっぱい（中央配置を確実にするため） */
        height: 70px;          /* 高さを出して大きく */
        font-size: 26px !important;  /* 文字を大きく */
        font-weight: bold;      /* 太字 */
        background-color: #ff4b4b; /* 目立つ赤色 */
        color: white;           /* 文字は白 */
        border-radius: 12px;    /* 角を少し丸く */
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* 少し影をつけて浮かせる */
    }
    /* ホバー時（マウスを乗せた時）の色の変化 */
    div.stButton > button:hover {
        background-color: #ff3333;
        border: none;
        color: white;
    }
    </style>
    """, unsafe_allow_html=True)
# --- 6. 査定ロジック ---
if st.button("AI査定を実行する"):
    # 推論用データの作成
    input_df = pd.DataFrame([{
        '区': ku,
        '所在': f"東京都{ku}{loc}",
        '専有面積': area,
        '駅より徒歩': walk,
        '築年月': year_now
    }])

    # 型の変換（カテゴリー型）
    input_df['区'] = input_df['区'].astype('category')
    input_df['所在'] = input_df['所在'].astype('category')

    # 現在価格予測
    price_base = model.predict(input_df)[0]
    
    # 5年後価格予測
    input_future = input_df.copy()
    input_future['築年月'] = year_now - 5
    price_future = model.predict(input_future)[0]
    
    # 賃料・利回り計算
    f = rent_factor.get(ku, 1.0)
    age_effect = max(0.65, 1.0 - (max(0, 2025 - year_now) * 0.008))
    m2_rent = 3300 * f * age_effect
    monthly_rent = m2_rent * area
    annual_rent_man = (monthly_rent * 12) / 10000
    yield_rate = (annual_rent_man / price_base) * 100

    # --- 7. 結果表示 ---
    st.divider()
    st.subheader(f"📊 診断結果: {ku} {loc}")
    
    m1, m2 = st.columns(2)
    m1.metric("AI統計ベース価格", f"{price_base:,.0f} 万円")
    m2.metric("AI予想利回り", f"{yield_rate:.2f} %")
    
    st.info(f"✨ **ブランド期待価格レンジ**: {int(price_base*0.95):,} 〜 {int(price_base*1.2):,} 万円")
    st.write(f"💡 5年後の予想価格: **{price_future:,.0f} 万円**")

    st.divider()
    st.subheader(f"🏙️ {ku}のマーケット分析")
    st.info(ku_details.get(ku, "データ準備中"))


