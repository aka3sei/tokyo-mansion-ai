import streamlit as st
import pandas as pd
import pickle
import lightgbm as lgb

# --- 1. データ定義（23区詳細レポート） ---
ku_market_data = {
    '千代田区': {
        '特徴': "番町・麹町を中心とした国内最高峰の邸宅街。供給が極めて少なく、資産維持率は国内トップクラスです。",
        '人気': "一番町〜六番町、麹町、紀尾井町、富士見、九段北",
        'ブランド': "パークマンション千鳥ヶ淵、ザ・パークハウスグラン三番町、プラウド一番町、ブランズ千代田富士見、ワテラスタワーレジデンス",
        '開発': "九段下・飯田橋周辺の駅前再開発により、歴史ある街並みに最新の利便性が加わっています。"
    },
    '中央区': {
        '特徴': "日本橋の商住近接エリアと勝どき・晴海の湾岸エリアが融合。流動性が非常に高いマーケットです。",
        '人気': "日本橋、人形町、勝どき、月島、晴海、築地",
        'ブランド': "パークタワー勝どきミッド/サウス、晴海フラッグ SKY DUO、プラウド日本橋三越前、パークホームズ日本橋時の鐘通り、ザ・パークハウス晴海タワーズ",
        '開発': "築地市場跡地の巨大開発や日本橋川の首都高地下化など、街の姿が劇的に進化中。"
    },
    '港区': {
        '特徴': "3A（青山・赤坂・麻布）は別格。国内外の富裕層や投資資金が集中する日本不動産の頂点です。",
        '人気': "元麻布、南青山、赤坂、白金高輪、芝浦、港南",
        'ブランド': "麻布台ヒルズレジデンス、パークコート赤坂檜町ザ・タワー、ワールドタワーレジデンス、元麻布ヒルズ、白金ザ・スカイ、ワールドシティタワーズ",
        '開発': "高輪ゲートウェイ駅周辺の『TAKANAWA GATEWAY CITY』全面開業を控え、期待値は最高潮です。"
    },
    '新宿区': {
        '特徴': "西新宿のタワー群から市谷・神楽坂の邸宅街まで多様な顔を持ち、職住近接需要が極めて強いエリア。",
        '人気': "市谷砂土原町、神楽坂、西新宿、下落合、富久町",
        'ブランド': "富久クロスコンフォートタワー、セントラルパークタワー・ラ・トゥール新宿、ザ・センター東京、プラウド新宿中落合、パークシティ高田馬場",
        '開発': "新宿駅西口（小田急・京王）の巨大再開発により、ターミナル機能と居住価値が再評価されています。"
    },
    '文京区': {
        '特徴': "山手線内側で最も教育環境に優れたエリア。文教地区ブランドにより、ファミリー層の指名買いが絶えません。",
        '人気': "本駒込（大和郷）、小石川、西片、千駄木、関口",
        'ブランド': "パークコート文京小石川ザ・タワー、プラウド文京千駄木、ザ・パークハウス小石川、グランドメゾン目白新坂、クレヴィア小石川後楽園",
        '開発': "春日・後楽園駅前の再開発完了により、伝統と先進が融合する完成度の高い街へ進化。"
    },
    '台東区': {
        '特徴': "上野・浅草の文化拠点と、蔵前周辺の再開発により若年富裕層が急増。地価上昇率が際立つエリアです。",
        '人気': "上野池之端、蔵前、浅草、谷中、三ノ輪",
        'ブランド': "ブリリアタワー上野池之端、パークホームズ蔵前レジデンス、プラウド浅草、ザ・パークハウス浅草、ルジェンテ上野",
        '開発': "蔵前駅前の複合開発や浅草通りの整備が進み、洗練された住宅街へと変貌を遂げました。"
    },
    '墨田区': {
        '特徴': "スカイツリー周辺の観光開発と錦糸町の高い商業利便性が魅力。共働き世帯に選ばれるエリア。",
        '人気': "錦糸町、両国、押上、向島、本所",
        'ブランド': "ザ・パークハウス錦糸町タワー、ブリリアタワー東京（錦糸町）、パークホームズ墨田、プラウドタワー亀戸クロス（近接）、シティハウス墨田",
        '開発': "錦糸町駅南口の再開発議論が進んでおり、将来的にはさらなる拠点性の向上が期待。"
    },
    '江東区': {
        '特徴': "湾岸タワーマンションの聖地。再開発による街の進化が続いており、将来的な資産価値も期待大。",
        '人気': "豊洲、有明、清澄白河、東陽町、門前仲町",
        'ブランド': "パークホームズ豊洲ザ・レジデンス、シティタワーズ東京ベイ（有明）、ブランズタワー豊洲、プラウドタワー門前仲町、パークアクシス豊洲",
        '開発': "地下鉄8号線（有楽町線）の延伸が決定。新駅設置により、周辺エリアの相場上昇が始まっています。"
    },
    '品川区': {
        '特徴': "御殿山等の邸宅地と武蔵小山・大崎の再開発が融合。交通の要所として圧倒的な強みを持ちます。",
        '人気': "御殿山、高輪、武蔵小山、大崎、東五反田",
        'ブランド': "パークシティ武蔵小山ザ・タワー、シティタワー武蔵小山、プラウドタワー目黒MARC、ブランズタワー大崎、パークコート白金長者丸",
        '開発': "品川駅のリニア始発駅化に向けた周辺整備により、将来の付加価値は抜群です。"
    },
    '目黒区': {
        '特徴': "洗練された東急沿線の文化と中目黒の活気が融合。高所得層が住みたい街の常連エリア。",
        '人気': "青葉台、自由が丘、中目黒、八雲、碑文谷",
        'ブランド': "プラウド駒場、パークタワー目黒、中目黒アトラスタワー、ザ・パークハウス自由が丘、ディアナコート碑文谷",
        '開発': "自由が丘駅前で複数の再開発が始動。駅前の景観が刷新され、ブランド価値がさらに向上。"
    },
    '大田区': {
        '特徴': "田園調布・山王の歴史的邸宅地から蒲田の利便性まで、幅広い需要をカバーする住宅都市。",
        '人気': "田園調布、山王、久が原、雪が谷大塚、下丸子",
        'ブランド': "プラウドシティ大田六郷、ザ・パークハウス山王、パークホームズ田園調布、ザ・リバープレイス、ブランズシティ久が原",
        '開発': "蒲蒲線（新空港線）計画や羽田跡地開発により、区南部のポテンシャルが再注目。"
    },
    '世田谷区': {
        '特徴': "国内最大級の住宅都市。良好な住環境が維持されており、資産価値の安定感は抜群です。",
        '人気': "成城、深沢、等々力、代沢、二子玉川",
        'ブランド': "プラウド二子玉川、グランドメゾン成城、ブランズ自由が丘（奥沢）、パークホームズ桜新町、深沢ハウス",
        '開発': "下北沢駅周辺の線路跡地開発により回遊性が向上し、感度の高い層の流入が加速。"
    },
    '渋谷区': {
        '特徴': "松濤や広尾の超一等地を擁する。需要が供給を常に上回る、国内屈指の希少エリア。",
        '人気': "広尾、松濤、代官山、神宮前、恵比寿",
        'ブランド': "パークマンション代官山、広尾ガーデンヒルズ、ザ・パークハウス渋谷美竹、プラウド青山、恵比寿ガーデンテラス壱番館",
        '開発': "渋谷駅周辺の「100年に一度」の巨大開発により、徒歩圏のマンション需要が激増。"
    },
    '中野区': {
        '特徴': "中野駅周辺の巨大再開発により一躍注目度が上昇。職・住・学が融合する熱いエリア。",
        '人気': "中野、東中野、本町、松が丘、弥生町",
        'ブランド': "パークタワー中野、中野ツインマークタワー、プラウド中野テラス、ザ・パークハウス中野、ユニオンマスタワー",
        '開発': "サンプラザ建て替えを含む4棟の大規模ビル建設により、ビジネス拠点機能が強化。"
    },
    '杉並区': {
        '特徴': "荻窪や浜田山など、落ち着いた環境が特徴。地に足の着いたファミリー層の支持が絶大。",
        '人気': "浜田山、荻窪、善福寺、久我山、阿佐ヶ谷",
        'ブランド': "パークシティ浜田山、プラウド荻窪、グランドメゾン杉並シーズン、パークホームズ阿佐ヶ谷、ザ・パークハウス荻窪レジデンス",
        '開発': "中央線の連続立体交差事業や駅前整備により、街の南北分断が解消され利便性が向上。"
    },
    '豊島区': {
        '特徴': "池袋の劇的再開発により評価が急上昇。東池袋のタワー群を中心に都心の新拠点へ進化。",
        '人気': "目白、南池袋、東池袋、駒込、巣鴨",
        'ブランド': "プラウドタワー東池袋ステーションアリーナ、ブリリアタワー池袋、グランドメゾン目白、ザ・タワー・グランディア、パークタワー上池袋",
        '開発': "池袋駅西口の巨大再開発が本格始動。三菱地所等による超高層ビル建設で格付けが変化。"
    },
    '北区': {
        '特徴': "赤羽の圧倒的交通利便性と西ヶ原の良好な環境。実利を重視する層に選ばれる堅実な区。",
        '人気': "赤羽、王子、西ヶ原、滝野川、田端",
        'ブランド': "プラウドシティ赤羽、シティテラス赤羽、パークホームズ王子、ザ・パークハウス駒込、プラウドシティ王子神谷",
        '開発': "赤羽一丁目街区の再開発や王子のまちづくりにより、城北のハブ機能が強化中。"
    },
    '荒川区': {
        '特徴': "日暮里・西日暮里の利便性が洗練。山手線アクセスを重視する共働き世帯に高評価。",
        '人気': "日暮里、西日暮里、南千住、町屋、東日暮里",
        'ブランド': "プラウド西日暮里、アトラス日暮里、パークホームズ南千住、ステーションガーデンタワー（日暮里）、ブランズ東日暮里",
        '開発': "西日暮里駅前で大規模なタワーと商業の複合開発が進行中。イメージが一新されます。"
    },
    '板橋区': {
        '特徴': "三田線による都心直通の利便性と、加賀エリアの歴史ある住環境が魅力。",
        '人気': "加賀、成増、板橋、志村坂上、常盤台",
        'ブランド': "加賀レジデンス、パークホームズ加賀、プラウド成増、ザ・パークハウス板橋、シティテラス板橋蓮根",
        '開発': "板橋駅西口の再開発タワー計画が進展。都心へのゲートウェイとしてのステータス向上。"
    },
    '練馬区': {
        '特徴': "23区屈指の緑の多さと副都心線による利便性が特徴。バランスの良い住宅都市。",
        '人気': "石神井公園、大泉学園、練馬、小竹向原、氷川台",
        'ブランド': "プラウド石神井公園、パークホームズ練馬、プラウドシティ大泉学園、シティタワー練馬、ザ・パークハウス氷川台",
        '開発': "石神井公園駅南口の再開発が進み、高級マンションと商業が調和する街並みが完成間近。"
    },
    '足立区': {
        '特徴': "北千住の躍進により人気が定着。高い利便性を誇り、近年はタワー開発も盛んです。",
        '人気': "北千住、綾瀬、西新井、千住、竹ノ塚",
        'ブランド': "プラウドタワー北千住、千住ザ・タワー、パークホームズ北千住、シティタワー千住大橋、ブランズシティ北千住",
        '開発': "北千住駅東口の大学誘致や綾瀬駅前の再開発により、若い世代の流入が加速。"
    },
    '葛飾区': {
        '特徴': "江戸川の自然と金町・新小岩の再開発が共存。近代的な街づくりが進む注目のエリア。",
        '人気': "金町、亀有、新小岩、柴又、青砥",
        'ブランド': "プラウドシティ金町、シティタワー金町、パークホームズ亀有ガーデンコート、プラウドタワー新小岩、ザ・パークハウス青砥",
        '開発': "新小岩駅ビルの完成や金町駅周辺の継続開発により、都心通勤層の受け皿として成長。"
    },
    '江戸川区': {
        '特徴': "子育て支援策は都内随一。東西線沿線の利便性と広い住環境を求める層に安定した人気。",
        '人気': "葛西、西葛西、船堀、小岩、瑞江",
        'ブランド': "プラウドタワー小岩、パークホームズ瑞江、プラウド瑞江、レジデントプレイス西葛西、ザ・パークハウス船堀",
        '開発': "小岩駅周辺で複数の再開発が同時進行中。下町のイメージを塗り替える変革期です。"
    }
}

# --- 2. ページ基本設定 ---
st.set_page_config(page_title="23区マンションAI査定", layout="centered")

st.title("🏙️ 東京23区マンション AI査定システム")
st.write("AIが統計データから「ベース価格」を算出し、ブランド価値を含めた「期待レンジ」を表示します。")

# --- 3. モデルの読み込み ---
@st.cache_resource
def load_model():
    with open('satei_model.pkl', 'rb') as f:
        return pickle.load(f)

try:
    model = load_model()
except Exception as e:
    st.error("モデルの読み込みに失敗しました。'satei_model.pkl' があるか確認してください。")

# --- 4. 賃料係数設定 ---
rent_factor = {
    '港区': 1.85, '千代田区': 1.85, '中央区': 1.75, '渋谷区': 1.75, '新宿区': 1.65,
    '文京区': 1.55, '目黒区': 1.55, '豊島区': 1.45, '台東区': 1.45, '品川区': 1.45,
    '世田谷区': 1.35, '中野区': 1.35, '杉並区': 1.30, '江東区': 1.30, '大田区': 1.25,
    '墨田区': 1.20, '荒川区': 1.15, '北区': 1.15, '練馬区': 1.10, '板橋区': 1.10,
    '江戸川区': 1.05, '足立区': 1.00, '葛飾区': 1.00
}

# --- 5. 入力フォーム ---
with st.container():
    col1, col2 = st.columns(2)
    with col1:
        ku = st.selectbox("区を選択", list(rent_factor.keys()))
        loc = st.text_input("所在地（例：南青山、勝どき）", "芝浦")
    with col2:
        area = st.number_input("専有面積 (㎡)", min_value=10.0, max_value=300.0, value=60.0, step=1.0)
        walk = st.slider("駅より徒歩 (分)", 0, 30, 5)
    year_now = st.number_input("築年月 (西暦)", min_value=1970, max_value=2025, value=2015)

# --- 6. 査定ボタン（中央配置デザイン） ---
st.markdown("""
    <style>
    /* 全体のフォント設定 */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
    body { font-family: 'Noto Sans JP', sans-serif; }

    /* ボタン中央配置 */
    .stButton { display: flex; justify-content: center; width: 100%; padding: 30px 0; }
    .stButton > button {
        width: 350px !important; height: 75px !important; font-size: 26px !important;
        background-color: #ff4b4b !important; color: white !important;
        border-radius: 15px !important; font-weight: bold !important;
        box-shadow: 0 4px 15px rgba(255, 75, 75, 0.4); border: none !important;
    }

    /* 4分割カードのデザイン */
    .market-card {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        border-top: 4px solid #ff4b4b; /* 左ではなく上にアクセント */
        box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* 柔らかい影 */
        height: 180px; /* 高さを揃えて整列させる */
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    .market-card:hover {
        transform: translateY(-5px); /* マウスを乗せると少し浮く */
    }
    .market-title {
        font-weight: bold;
        color: #ff4b4b;
        margin-bottom: 10px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .market-content {
        font-size: 0.95rem;
        color: #333;
        line-height: 1.6;
    }
    </style>
    """, unsafe_allow_html=True)

# ボタンの実行
if st.button("AI査定を実行する"):
    # --- 推論処理 ---
    input_df = pd.DataFrame([{
        '区': ku,
        '所在': f"東京都{ku}{loc}",
        '専有面積': area,
        '駅より徒歩': walk,
        '築年月': year_now
    }])

    # カテゴリー型へ変換
    input_df['区'] = input_df['区'].astype('category')
    input_df['所在'] = input_df['所在'].astype('category')

    # 予測
    price_base = model.predict(input_df)[0]
    
    input_future = input_df.copy()
    input_future['築年月'] = year_now - 5
    price_future = model.predict(input_future)[0]
    
    # 計算
    f = rent_factor.get(ku, 1.0)
    age_effect = max(0.65, 1.0 - (max(0, 2025 - year_now) * 0.008))
    m2_rent = 3300 * f * age_effect
    monthly_rent = m2_rent * area
    annual_rent_man = (monthly_rent * 12) / 10000
    yield_rate = (annual_rent_man / price_base) * 100

    # --- 7. 結果表示 ---
    st.divider()
    st.subheader(f"📊 診断結果: {ku} {loc}")
    
    m1, m2 = st.columns(2)
    m1.metric("AI統計ベース価格", f"{price_base:,.0f} 万円")
    m2.metric("AI予想利回り", f"{yield_rate:.2f} %")
    
    st.info(f"✨ **ブランド期待価格レンジ**: {round(price_base*1.0):,} 〜 {round(price_base*1.2):,} 万円")
    st.write(f"💡 5年後の予想価格: **{price_future:,.0f} 万円**")

    st.divider()
    st.subheader(f"🏙️ {ku}のマーケット分析")
    
    # --- 8. マーケット分析（デザイン改良版） ---
    st.divider()
    st.subheader(f"🏙️ {ku}のマーケット詳細分析")
    
    data = ku_market_data.get(ku)
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown(f"""
            <div class="market-card">
                <div class="market-title">📍 エリアの特徴</div>
                <div class="market-content">{data['特徴']}</div>
            </div>
            <div class="market-card">
                <div class="market-title">🏢 主要ブランド</div>
                <div class="market-content">{data['ブランド']}</div>
            </div>
        """, unsafe_allow_html=True)
        
    with col2:
        st.markdown(f"""
            <div class="market-card">
                <div class="market-title">🗺️ 人気エリア</div>
                <div class="market-content">{data['人気']}</div>
            </div>
            <div class="market-card">
                <div class="market-title">🏗️ 再開発・将来性</div>
                <div class="market-content">{data['開発']}</div>
            </div>
        """, unsafe_allow_html=True)





