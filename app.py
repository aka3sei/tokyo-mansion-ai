import streamlit as st
import pandas as pd
import pickle
import lightgbm as lgb

# --- 1. データ定義（ここが一番重要です） ---

# 23区別：正式町名マスターリスト（板橋区熊野町など漏れ補正版）
rent_factor = {
    '千代田区': 1.25, '中央区': 1.18, '港区': 1.35, '新宿区': 1.10, '文京区': 1.05,
    '台東区': 1.00, '墨田区': 0.95, '江東区': 1.02, '品川区': 1.08, '目黒区': 1.15,
    '大田区': 0.92, '世田谷区': 1.03, '渋谷区': 1.20, '中野区': 0.98, '杉並区': 0.96,
    '豊島区': 1.02, '北区': 0.90, '荒川区': 0.88, '板橋区': 0.87, '練馬区': 0.86,
    '足立区': 0.82, '葛飾区': 0.80, '江戸川区': 0.83
}
town_data = {
    '千代田区': [
        '一番町', '二番町', '三番町', '四番町', '五番町', '六番町', '紀白井町', '麹町', '富士見', '飯田橋', '九段北', '九段南', '隼町', '平河町', '永田町', '霞が関', '内幸町', '有楽町', '内神田', '外神田', '神田相生町', '神田淡路町', '神田和泉町', '神田岩本町', '神田小川町', '神田鍛冶町', '神田北乗物町', '神田紺屋町', '神田佐久間河岸', '神田佐久間町', '神田神保町', '神田須田町', '神田駿河台', '神田多町', '神田司町', '神田富山町', '神田錦町', '神田西福田町', '神田練塀町', '神田花岡町', '神田東紺屋町', '神田東松下町', '神田平河町', '神田松永町', '神田美倉町', '神田美土代町', '岩本町', '東神田', '西神田', '三崎町', '猿楽町', '丸の内', '大手町', '一ツ橋'
    ],
    '中央区': [
        '日本橋', '日本橋大伝馬町', '日本橋小伝馬町', '日本橋馬喰町', '日本橋横山町', '日本橋久松町', '日本橋浜町', '日本橋中洲', '日本橋富沢町', '日本橋人形町', '日本橋小網町', '日本橋蛎殻町', '日本橋箱崎町', '日本橋小舟町', '日本橋堀留町', '日本橋本町', '日本橋室町', '日本橋本石町', '日本橋兜町', '日本橋茅場町', '京橋', '銀座', '築地', '入船', '湊', '新富', '八丁堀', '新川', '八重洲', '明石町', '浜離宮庭園', '勝どき', '豊海町', '月島', '晴海', '佃'
    ],
    '港区': [
        '芝', '芝大門', '芝公園', '海岸', '三田', '芝浦', '港南', '高輪', '白金', '白金台', '麻布十番', '麻布狸穴町', '麻布永坂町', '麻布台', '東麻布', '元麻布', '南麻布', '西麻布', '六本木', '赤坂', '元赤坂', '北青山', '南青山', '虎ノ門', '愛宕', '新橋', '東新橋', '西新橋', '台場'
    ],
    '新宿区': [
        '新宿', '西新宿', '北新宿', '歌舞伎町', '高田馬場', '下落合', '中落合', '上落合', '西落合', '戸塚町', '早稲田町', '早稲田鶴巻町', '早稲田南町', '戸山', '若松町', '余丁町', '富久町', '市谷砂土原町', '市谷船河原町', '市谷加賀町', '市谷甲良町', '市谷山伏町', '市谷八幡町', '市谷本村町', '神楽坂', '二十騎町', '揚場町', '津久戸町', '下宮比町', '矢来町', '横寺町', '袋町', '若宮町', '岩戸町', '払方町', '納戸町', '中町', '南町', '北町', '細工町', '箪笥町', '築地町', '赤城元町', '赤城下町', '東五軒町', '新小川町', '西五軒町', '白銀町', '神楽河岸', '信濃町', '南元町', '左門町', '須賀町', '若葉', '舟町', '愛住町', '大京町', '内藤町', '霞ヶ丘町', '四谷'
    ],
    '文京区': [
        '本郷', '後楽', '春日', '小石川', '白山', '千石', '本駒込', '駒込', '向丘', '西片', '弥生', '根津', '千駄木', '湯島', '水道', '小日向', '音羽', '目白台', '関口', '大塚'
    ],
    '台東区': [
        '浅草', '浅草橋', '駒形', '寿', '蔵前', '三筋', '小島', '鳥越', '台東', '柳橋', '元浅草', '東上野', '上野', '池之端', '上野桜木', '谷中', '根岸', '入谷', '下谷', '竜泉', '三ノ輪', '日本堤', '清川', '橋場', '今戸', '東浅草', '千束', '花川戸'
    ],
    '墨田区': [
        '吾妻橋', '東駒形', '本所', '石原', '横網', '亀沢', '緑', '立川', '菊川', '江東橋', '錦糸', '太平', '横川', '業平', '押上', '向島', '東向島', '墨田', '堤通', '京島', '文花', '立花', '八広'
    ],
    '江東区': [
        '三好', '白河', '平野', '清澄', '深川', '冬木', '永代', '佐賀', '福住', '門前仲町', '富岡', '牡丹', '古石場', '越中島', '塩浜', '枝川', '木場', '東陽', '千石', '石島', '千田', '海辺', '扇橋', '猿江', '住吉', '毛利', '森下', '常盤', '新大橋', '高橋', '亀戸', '大島', '北砂', '東砂', '南砂', '新砂', '若洲', '新木場', '夢の島', '辰巳', '潮見', '豊洲', '有明', '青海'
    ],
    '品川区': [
        '北品川', '東品川', '南品川', '広町', '西品川', '豊町', '戸越', '平塚', '中延', '東中延', '西中延', '旗の台', '荏原', '小山', '小山台', '東五反田', '西五反田', '大崎', '上大崎', '東大井', '南大井', '西大井', '勝島', '八潮'
    ],
    '目黒区': [
        '駒場', '大橋', '青葉台', '東山', '上目黒', '中目黒', '目黒', '下目黒', '三田', '祐天寺', '五本木', '中央町', '中町', '目黒本町', '原町', '洗足', '南', '碑文谷', '鷹番', '平町', '大岡山', '緑が丘', '自由が丘', '中根', '柿の木坂', '八雲', '東が丘'
    ],
    '大田区': [
        '大森北', '大森本町', '大森中', '大森東', '大森南', '大森西', '山王', '中央', '蒲田', '蒲田本町', '東蒲田', '西蒲田', '新蒲田', '南蒲田', '北蒲田', '萩中', '本羽田', '羽田', '羽田旭町', '東糀谷', '西糀谷', '平和島', '昭和島', '京浜島', '東海', '城南島', '多摩川', '東矢口', '矢口', '下丸子', '鵜の木', '千鳥', '南久が原', '久が原', '仲池上', '上池台', '東雪谷', '南雪谷', '雪が谷大塚町', '石川町', '田園調布', '田園調布本町', '田園調布南', '北嶺町', '南嶺町', '西嶺町', '東嶺町', '仲六郷', '東六郷', '西六郷', '南六郷'
    ],
    '世田谷区': [
        '世田谷', '桜', '桜丘', '上馬', '下馬', '野沢', '若林', '太子堂', '三軒茶屋', '池尻', '三宿', '代沢', '北沢', '代田', '大原', '羽根木', '松原', '赤堤', '梅丘', '豪徳寺', '宮坂', '経堂', '奥沢', '尾山台', '等々力', '上野毛', '野毛', '中町', '玉堤', '瀬田', '玉川', '用賀', '玉川台', '上用賀', '深沢', '駒沢', '新町', '桜新町', '弦巻', '成城', '祖師谷', '千歳台', '船橋', '粕谷', '鎌田', '岡本', '大蔵', '喜多見', '宇奈根', '砧', '砧公園', '上北沢', '桜上水', '給田', '南烏山', '北烏山'
    ],
    '渋谷区': [
        '渋谷', '東', '広尾', '恵比寿', '恵比寿西', '恵比寿南', '代官山町', '猿楽町', '鉢山町', '鶯谷町', '桜丘町', '南平台町', '道玄坂', '円山町', '神泉町', '松濤', '神山町', '宇田川町', '神南', '西原', '大山町', '上原', '元代々木町', '富ヶ谷', '代々木', '千駄ヶ谷', '神宮前', '本町', '笹塚', '幡ヶ谷', '代々木神園町'
    ],
    '中野区': [
        '中野', '新井', '野方', '沼袋', '松が丘', '江古田', '丸山', '江原町', '上高田', '東中野', '中央', '本町', '弥生町', '南台', '若宮', '白鷺', '鷺宮', '上鷺宮'
    ],
    '杉並区': [
        '阿佐ヶ谷南', '阿佐ヶ谷北', '天沼', '本天沼', '成田東', '成田西', '荻窪', '南荻窪', '上荻', '清水', '井草', '下井草', '上井草', '今川', '桃井', '善福寺', '西荻南', '西荻北', '松庵', '宮前', '久我山', '高井戸東', '高井戸西', '上高井戸', '下高井戸', '浜田山', '永福', '和泉', '方南', '和田', '堀ノ内', '松ノ木', '大宮', '梅里', '高円寺南', '高円寺北'
    ],
    '豊島区': [
        '駒込', '巣鴨', '北大塚', '南大塚', '西巣鴨', '上池袋', '東池袋', '南池袋', '池袋', '池袋本町', '西池袋', '目白', '南長崎', '長崎', '千早', '要町', '高松', '千川', '雑司が谷', '高田'
    ],
    '北区': [
        '赤羽', '赤羽台', '赤羽西', '赤羽南', '赤羽北', '岩淵町', '志茂', '浮間', '神谷', '王子', '王子本町', '豊島', '堀船', '岸町', '東十条', '中十条', '上十条', '十条仲原', '十条台', '西ヶ原', '栄町', '上中里', '中里', '昭和町', '東田端', '田端', '田端新町', '滝野川', '西が丘'
    ],
    '荒川区': [
        '荒川', '町屋', '東尾久', '西尾久', '東日暮里', '西日暮里', '南千住'
    ],
    '板橋区': [
        '板橋', '加賀', '仲宿', '氷川町', '栄町', '中板橋', '仲町', '弥生町', '本町', '稲荷台', '大和町', '双葉町', '富士見町', '大山町', '大山西町', '大山金井町', '幸町', '中丸町', '南町', '三園', '東山町', '東新町', '桜川', '上板橋', '常盤台', '南常盤台', '前野町', '若木', '中台', '西台', '蓮根', '坂下', '東坂下', '小豆沢', '志村', '清水町', '蓮沼町', '大原町', '泉町', '宮本町', '本蓮沼', '高島平', '新河岸', '舟渡', '徳丸', '四葉', '赤塚', '赤塚新町', '成増', '大門', '熊野町'
    ],
    '練馬区': [
        '練馬', '桜台', '栄町', '羽沢', '豊玉北', '豊玉上', '豊玉中', '豊玉南', '中村北', '中村', '中村南', '向山', '貫井', '春日町', '早宮', '平和台', '氷川台', '錦', '北町', '田柄', '光が丘', '旭町', '土支田', '高松', '谷原', '三原台', '富士見台', '南田中', '下石神井', '石神井町', '石神井台', '上石神井', '上石神井南町', '立野町', '関町東', '関町南', '関町北', '東大泉', '西大泉', '南大泉', '大泉学園町', '大泉町'
    ],
    '足立区': [
        '千住', '千住曙町', '千住旭町', '千住東', '千住桜木', '千住関屋町', '千住龍田町', '千住中居町', '千住仲町', '千住橋戸町', '千住緑町', '千住宮元町', '千住元町', '千住柳町', '足立', '中央本町', '梅島', '梅田', '西新井', '西新井栄町', '西新井本町', '関原', '本木', '本木東町', '本木西町', '本木南町', '扇', '興野', '江北', '谷在', '鹿浜', '加賀', '皿沼', '椿', '堀之内', '新田', '宮城', '小台', '綾瀬', '弘道', '青井', '栗原', '島根', '六月', '竹ノ塚', '保木間', '東保木間', '西保木間', '花畑', '南花畑', '神明', '神明南', '六町', '一ツ家', '平野', '東六月町', '保塚町', '辰沼', '谷中', '加平', '北加平町', '西加平', '東綾瀬', '大谷田', '佐野', '中川', '東和', '古千谷', '古千谷本町', '舎人', '舎人町', '舎人公園', '入谷', '入谷町'
    ],
    '葛飾区': [
        '立石', '四つ木', '東四つ木', '宝町', '堀切', 'お花茶屋', '東堀切', '白鳥', '青戸', '高砂', '鎌倉', '細田', '奥戸', '東新小岩', '新小岩', '西新小岩', '東金町', '金町', '新宿', '亀有', '西亀有', '小菅', '東水元', '水元', '水元公園', '西水元', '南水元'
    ],
    '江戸川区': [
        '中央', '松島', '松江', '平井', '小松川', '東小松川', '西小松川', '西一之江', '一之江', '一之江町', '二之江町', '春江町', '瑞江', '西瑞江', '江戸川', '東瑞江', '南瑞江', '東葛西', '西葛西', '中葛西', '南葛西', '北葛西', '清新町', '臨海町', '船堀', '北一之江', '大杉', '本一色', '上一色', '鹿骨', '東松本', '松本', '興宮町', '小岩', '東小岩', '西小岩', '南小岩', '北小岩', '新堀', '谷河内'
    ]
}

# 23区別：マーケット分析用データ（4項目）
ku_market_data = {
    '千代田区': {
        '特徴': "番町・麹町を中心とした国内最高峰の邸宅街。供給が極めて少なく、資産維持率は国内トップクラスです。",
        '人気': "一番町〜六番町、麹町、紀尾井町、富士見、九段北",
        'ブランド': "パークマンション千鳥ヶ淵、ザ・パークハウスグラン三番町、プラウド一番町、ブランズ千代田富士見、ワテラスタワーレジデンス",
        '開発': "九段下・飯田橋周辺の駅前再開発により、歴史ある街並みに最新の利便性が加わっています。"
    },
    '中央区': {
        '特徴': "日本橋の商住近接エリアと勝どき・晴海の湾岸エリアが融合。流動性が非常に高いマーケットです。",
        '人気': "日本橋、人形町、勝どき、月島、晴海、築地",
        'ブランド': "パークタワー勝どきミッド/サウス、晴海フラッグ SKY DUO、プラウド日本橋三越前、パークホームズ日本橋時の鐘通り、ザ・パークハウス晴海タワーズ",
        '開発': "築地市場跡地の巨大開発や日本橋川の首都高地下化など、街の姿が劇的に進化中。"
    },
    '港区': {
        '特徴': "3A（青山・赤坂・麻布）は別格。国内外の富裕層や投資資金が集中する日本不動産の頂点です。",
        '人気': "元麻布、南青山、赤坂、白金高輪、芝浦、港南",
        'ブランド': "麻布台ヒルズレジデンス、パークコート赤坂檜町ザ・タワー、ワールドタワーレジデンス、元麻布ヒルズ、白金ザ・スカイ、ワールドシティタワーズ",
        '開発': "高輪ゲートウェイ駅周辺の『TAKANAWA GATEWAY CITY』全面開業を控え、期待値は最高潮です。"
    },
    '新宿区': {
        '特徴': "西新宿のタワー群から市谷・神楽坂の邸宅街まで多様な顔を持ち、職住近接需要が極めて強いエリア。",
        '人気': "市谷砂土原町、神楽坂、西新宿、下落合、富久町",
        'ブランド': "富久クロスコンフォートタワー、セントラルパークタワー・ラ・トゥール新宿、ザ・センター東京、プラウド新宿中落合、パークシティ高田馬場",
        '開発': "新宿駅西口（小田急・京王）の巨大再開発により、ターミナル機能と居住価値が再評価されています。"
    },
    '文京区': {
        '特徴': "山手線内側で最も教育環境に優れたエリア。文教地区ブランドにより、ファミリー層の指名買いが絶えません。",
        '人気': "本駒込（大和郷）、小石川、西片、千駄木、関口",
        'ブランド': "パークコート文京小石川ザ・タワー、プラウド文京千駄木、ザ・パークハウス小石川、グランドメゾン目白新坂、クレヴィア小石川後楽園",
        '開発': "春日・後楽園駅前の再開発完了により、伝統と先進が融合する完成度の高い街へ進化。"
    },
    '台東区': {
        '特徴': "上野・浅草の文化拠点と、蔵前周辺の再開発により若年富裕層が急増。地価上昇率が際立つエリアです。",
        '人気': "上野池之端、蔵前、浅草、谷中、三ノ輪",
        'ブランド': "ブリリアタワー上野池之端、パークホームズ蔵前レジデンス、プラウド浅草、ザ・パークハウス浅草、ルジェンテ上野",
        '開発': "蔵前駅前の複合開発や浅草通りの整備が進み、洗練された住宅街へと変貌を遂げました。"
    },
    '墨田区': {
        '特徴': "スカイツリー周辺の観光開発と錦糸町の高い商業利便性が魅力。共働き世帯に選ばれるエリア。",
        '人気': "錦糸町、両国、押上、向島、本所",
        'ブランド': "ザ・パークハウス錦糸町タワー、ブリリアタワー東京（錦糸町）、パークホームズ墨田、プラウドタワー亀戸クロス（近接）、シティハウス墨田",
        '開発': "錦糸町駅南口の再開発議論が進んでおり、将来的にはさらなる拠点性の向上が期待。"
    },
    '江東区': {
        '特徴': "湾岸タワーマンションの聖地。再開発による街の進化が続いており、将来的な資産価値も期待大。",
        '人気': "豊洲、有明、清澄白河、東陽町、門前仲町",
        'ブランド': "パークホームズ豊洲ザ・レジデンス、シティタワーズ東京ベイ（有明）、ブランズタワー豊洲、プラウドタワー門前仲町、パークアクシス豊洲",
        '開発': "地下鉄8号線（有楽町線）の延伸が決定。新駅設置により、周辺エリアの相場上昇が始まっています。"
    },
    '品川区': {
        '特徴': "御殿山等の邸宅地と武蔵小山・大崎の再開発が融合。交通の要所として圧倒的な強みを持ちます。",
        '人気': "御殿山、高輪、武蔵小山、大崎、東五反田",
        'ブランド': "パークシティ武蔵小山ザ・タワー、シティタワー武蔵小山、プラウドタワー目黒MARC、ブランズタワー大崎、パークコート白金長者丸",
        '開発': "品川駅のリニア始発駅化に向けた周辺整備により、将来の付加価値は抜群です。"
    },
    '目黒区': {
        '特徴': "洗練された東急沿線の文化と中目黒の活気が融合。高所得層が住みたい街の常連エリア。",
        '人気': "青葉台、自由が丘、中目黒、八雲、碑文谷",
        'ブランド': "プラウド駒場、パークタワー目黒、中目黒アトラスタワー、ザ・パークハウス自由が丘、ディアナコート碑文谷",
        '開発': "自由が丘駅前で複数の再開発が始動。駅前の景観が刷新され、ブランド価値がさらに向上。"
    },
    '大田区': {
        '特徴': "田園調布・山王の歴史的邸宅地から蒲田の利便性まで、幅広い需要をカバーする住宅都市。",
        '人気': "田園調布、山王、久が原、雪が谷大塚、下丸子",
        'ブランド': "プラウドシティ大田六郷、ザ・パークハウス山王、パークホームズ田園調布、ザ・リバープレイス、ブランズシティ久が原",
        '開発': "蒲蒲線（新空港線）計画や羽田跡地開発により、区南部のポテンシャルが再注目。"
    },
    '世田谷区': {
        '特徴': "国内最大級の住宅都市。良好な住環境が維持されており、資産価値の安定感は抜群です。",
        '人気': "成城、深沢、等々力、代沢、二子玉川",
        'ブランド': "プラウド二子玉川、グランドメゾン成城、ブランズ自由が丘（奥沢）、パークホームズ桜新町、深沢ハウス",
        '開発': "下北沢駅周辺の線路跡地開発により回遊性が向上し、感度の高い層の流入が加速。"
    },
    '渋谷区': {
        '特徴': "松濤や広尾の超一等地を擁する。需要が供給を常に上回る、国内屈指の希少エリア。",
        '人気': "広尾、松濤、代官山、神宮前、恵比寿",
        'ブランド': "パークマンション代官山、広尾ガーデンヒルズ、ザ・パークハウス渋谷美竹、プラウド青山、恵比寿ガーデンテラス壱番館",
        '開発': "渋谷駅周辺の「100年に一度」の巨大開発により、徒歩圏のマンション需要が激増。"
    },
    '中野区': {
        '特徴': "中野駅周辺の巨大再開発により一躍注目度が上昇。職・住・学が融合する熱いエリア。",
        '人気': "中野、東中野、本町、松が丘、弥生町",
        'ブランド': "パークタワー中野、中野ツインマークタワー、プラウド中野テラス、ザ・パークハウス中野、ユニオンマスタワー",
        '開発': "サンプラザ建て替えを含む4棟の大規模ビル建設により、ビジネス拠点機能が強化。"
    },
    '杉並区': {
        '特徴': "荻窪や浜田山など、落ち着いた環境が特徴。地に足の着いたファミリー層の支持が絶大。",
        '人気': "浜田山、荻窪、善福寺、久我山、阿佐ヶ谷",
        'ブランド': "パークシティ浜田山、プラウド荻窪、グランドメゾン杉並シーズン、パークホームズ阿佐ヶ谷、ザ・パークハウス荻窪レジデンス",
        '開発': "中央線の連続立体交差事業や駅前整備により、街の南北分断が解消され利便性が向上。"
    },
    '豊島区': {
        '特徴': "池袋の劇的再開発により評価が急上昇。東池袋のタワー群を中心に都心の新拠点へ進化。",
        '人気': "目白、南池袋、東池袋、駒込、巣鴨",
        'ブランド': "プラウドタワー東池袋ステーションアリーナ、ブリリアタワー池袋、グランドメゾン目白、ザ・タワー・グランディア、パークタワー上池袋",
        '開発': "池袋駅西口の巨大再開発が本格始動。三菱地所等による超高層ビル建設で格付けが変化。"
    },
    '北区': {
        '特徴': "赤羽の圧倒的交通利便性と西ヶ原の良好な環境。実利を重視する層に選ばれる堅実な区。",
        '人気': "赤羽、王子、西ヶ原、滝野川、田端",
        'ブランド': "プラウドシティ赤羽、シティテラス赤羽、パークホームズ王子、ザ・パークハウス駒込、プラウドシティ王子神谷",
        '開発': "赤羽一丁目街区の再開発や王子のまちづくりにより、城北のハブ機能が強化中。"
    },
    '荒川区': {
        '特徴': "日暮里・西日暮里の利便性が洗練。山手線アクセスを重視する共働き世帯に高評価。",
        '人気': "日暮里、西日暮里、南千住、町屋、東日暮里",
        'ブランド': "プラウド西日暮里、アトラス日暮里、パークホームズ南千住、ステーションガーデンタワー（日暮里）、ブランズ東日暮里",
        '開発': "西日暮里駅前で大規模なタワーと商業の複合開発が進行中。イメージが一新されます。"
    },
    '板橋区': {
        '特徴': "三田線による都心直通の利便性と、加賀エリアの歴史ある住環境が魅力。",
        '人気': "加賀、成増、板橋、志村坂上、常盤台",
        'ブランド': "加賀レジデンス、パークホームズ加賀、プラウド成増、ザ・パークハウス板橋、シティテラス板橋蓮根",
        '開発': "板橋駅西口の再開発タワー計画が進展。都心へのゲートウェイとしてのステータス向上。"
    },
    '練馬区': {
        '特徴': "23区屈指の緑の多さと副都心線による利便性が特徴。バランスの良い住宅都市。",
        '人気': "石神井公園、大泉学園、練馬、小竹向原、氷川台",
        'ブランド': "プラウド石神井公園、パークホームズ練馬、プラウドシティ大泉学園、シティタワー練馬、ザ・パークハウス氷川台",
        '開発': "石神井公園駅南口の再開発が進み、高級マンションと商業が調和する街並みが完成間近。"
    },
    '足立区': {
        '特徴': "北千住の躍進により人気が定着。高い利便性を誇り、近年はタワー開発も盛んです。",
        '人気': "北千住、綾瀬、西新井、千住、竹ノ塚",
        'ブランド': "プラウドタワー北千住、千住ザ・タワー、パークホームズ北千住、シティタワー千住大橋、ブランズシティ北千住",
        '開発': "北千住駅東口の大学誘致や綾瀬駅前の再開発により、若い世代の流入が加速。"
    },
    '葛飾区': {
        '特徴': "江戸川の自然と金町・新小岩の再開発が共存。近代的な街づくりが進む注目のエリア。",
        '人気': "金町、亀有、新小岩、柴又、青砥",
        'ブランド': "プラウドシティ金町、シティタワー金町、パークホームズ亀有ガーデンコート、プラウドタワー新小岩、ザ・パークハウス青砥",
        '開発': "新小岩駅ビルの完成や金町駅周辺の継続開発により、都心通勤層の受け皿として成長。"
    },
    '江戸川区': {
        '特徴': "子育て支援策は都内随一。東西線沿線の利便性と広い住環境を求める層に安定した人気。",
        '人気': "葛西、西葛西、船堀、小岩、瑞江",
        'ブランド': "プラウドタワー小岩、パークホームズ瑞江、プラウド瑞江、レジデントプレイス西葛西、ザ・パークハウス船堀",
        '開発': "小岩駅周辺で複数の再開発が同時進行中。下町のイメージを塗り替える変革期です。"
    }
}

# --- 2. ページ設定とスタイル ---
st.set_page_config(page_title="23区マンションAI査定", layout="centered")

st.markdown("""
    <style>
    .market-card {
        background-color: white; padding: 20px; border-radius: 12px;
        border-top: 4px solid #ff4b4b; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 200px; margin-bottom: 20px;
    }
    .market-title { font-weight: bold; color: #ff4b4b; margin-bottom: 10px; font-size: 1.1rem; }
    .market-content { font-size: 0.95rem; color: #333; line-height: 1.6; }
    </style>
    """, unsafe_allow_html=True)

# --- 3. モデル読み込み ---
@st.cache_resource
def load_model():
    with open('satei_model.pkl', 'rb') as f:
        return pickle.load(f)

model = load_model()

# --- 4. 入力フォーム（ここを選択式に変更） ---
st.title("🏙️ 東京23区マンション AI査定")

with st.container():
    col1, col2 = st.columns(2)
    with col1:
        # 区を選択
        selected_ku = st.selectbox("区を選択", list(ku_market_data.keys()))
        
        # 町名を選択（選ばれた区に連動してtown_dataからリストを表示）
        town_options = town_data.get(selected_ku, ["その他"])
        selected_loc = st.selectbox("所在地（町名）を選択", town_options)
        
    with col2:
        # step=1.0 にすることで1㎡ずつ変化し、format="%d" で整数表示にします
        area = st.number_input("専有面積 (㎡)", min_value=10, max_value=300, value=60, step=1, format="%d")
        walk = st.slider("駅より徒歩 (分)", 0, 30, 5)
    
    year_now = st.number_input("築年月 (西暦)", value=2015)

# --- 5. 査定実行と結果表示 ---
if st.button("AI査定を実行する"):
    # 1. 住所文字列の作成
    full_address = f"東京都{selected_ku}{selected_loc}"
    
    # 2. AIに渡すデータフレームの作成 (ここで input_df を確実に定義)
    # カラム名は、AIモデル学習時と同じ「区」「所在」「専有面積」「駅より徒歩」「築年月」にします
    input_df = pd.DataFrame([{
        '区': selected_ku, 
        '所在': full_address, 
        '専有面積': area, 
        '駅より徒歩': walk, 
        '築年月': year_now
    }])

    # 3. データ型の変換（LightGBMなどのモデルに必要）
    input_df['区'] = input_df['区'].astype('category')
    input_df['所在'] = input_df['所在'].astype('category')
    
    # 4. 推論の実行
    try:
        price_base = model.predict(input_df)[0]
        
        # 5年後予想価格の計算
        input_future = input_df.copy()
        input_future['築年月'] = year_now - 5
        price_future = model.predict(input_future)[0]
        
        # --- 結果の表示 ---
        st.divider()
        st.subheader(f"📊 診断結果: {selected_ku} {selected_loc}")
        
        m1, m2 = st.columns(2)
        m1.metric("AI統計ベース価格", f"{round(price_base):,} 万円")
        
        # 利回り計算
        f = rent_factor.get(selected_ku, 1.0)
        age_effect = max(0.65, 1.0 - (max(0, 2025 - year_now) * 0.008))
        m2_rent = 3300 * f * age_effect
        annual_rent_man = (m2_rent * area * 12) / 10000
        yield_rate = (annual_rent_man / price_base) * 100
        m2.metric("AI予想利回り", f"{yield_rate:.2f} %")
        
        st.info(f"✨ **ブランド期待価格レンジ**: {round(price_base):,} 〜 {round(price_base*1.25):,} 万円")
        st.write(f"💡 5年後の予想価格: **{price_future:,.0f} 万円**")

        # --- 8. マーケット分析のカード表示（ここも続けて記述） ---
        st.divider()
        st.subheader(f"🏙️ {selected_ku}のマーケット詳細分析")
        
        data = ku_market_data.get(selected_ku)
        col1, col2 = st.columns(2)
        with col1:
            st.markdown(f"""<div class="market-card"><div class="market-title">📍 特徴</div><div class="market-content">{data['特徴']}</div></div>""", unsafe_allow_html=True)
            st.markdown(f"""<div class="market-card"><div class="market-title">🏢 ブランド</div><div class="market-content">{data['ブランド']}</div></div>""", unsafe_allow_html=True)
        with col2:
            st.markdown(f"""<div class="market-card"><div class="market-title">🗺️ 人気</div><div class="market-content">{data['人気']}</div></div>""", unsafe_allow_html=True)
            st.markdown(f"""<div class="market-card"><div class="market-title">🏗️ 開発</div><div class="market-content">{data['開発']}</div></div>""", unsafe_allow_html=True)

    except NameError as e:
        st.error(f"変数名が正しくありません: {e}")
    except Exception as e:
        st.error(f"査定中にエラーが発生しました: {e}")
   


